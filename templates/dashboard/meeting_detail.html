{% extends 'dashboard/base.html' %}

{% block title %}{{ meeting.title|default:"Meeting" }} - huddle{% endblock %}

{% block dashboard_content %}
<!-- Simple header with status -->
<div class="header">
    <div class="flex-between">
        <div>
            <h1 style="font-size: 20px; margin-bottom: 4px; font-weight: 500;">{{ meeting.title|default:"Untitled Meeting" }}</h1>
            <div class="text-muted text-small">Meeting {{ meeting.meeting_id }} â€¢ {{ meeting.created_at|date:"M j, Y" }}</div>
        </div>
        
        <div>
            {% if meeting.is_active %}
                <div class="status status-active">
                    <i class="fas fa-circle" style="font-size: 8px;"></i>
                    Active
                </div>
            {% else %}
                <div class="status status-completed">
                    <i class="fas fa-circle" style="font-size: 8px;"></i>
                    Inactive
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Simple stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 40px;">
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">{{ attendee_status|length }}</div>
        <div class="text-muted text-small">Attendees</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">
            {% for attendee in attendee_status %}{% if attendee.has_voice %}{{ forloop.counter }}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div class="text-muted text-small">Ready</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">
            {% for attendee in attendee_status %}{% if not attendee.has_voice %}{{ forloop.counter }}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div class="text-muted text-small">Need Setup</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Agenda Management -->
    <div class="card">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Meeting Agenda</h3>
            <button onclick="showAddAgendaModal()" class="btn">
                <i class="fas fa-plus"></i>
                Add Item
            </button>
        </div>

        <div id="agenda-items" class="agenda-items">
            <!-- Agenda items will be loaded here -->
        </div>

        <div id="empty-agenda" style="text-align: center; padding: 40px; color: #666; display: none;">
            <i class="fas fa-list-ul" style="font-size: 32px; margin-bottom: 12px; opacity: 0.5;"></i>
            <div>No agenda items yet</div>
            <div class="text-small text-muted">Add items to structure your meeting</div>
        </div>
    </div>

    <!-- Attendee Management -->
    <div class="card">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Attendees</h3>
            <button onclick="showAddAttendeeModal()" class="btn">
                <i class="fas fa-plus"></i>
                Add
            </button>
        </div>
        
        {% if attendee_status %}
            <table>
                <thead>
                    <tr>
                        <th>Attendee</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendee in attendee_status %}
                    <tr data-email="{{ attendee.email }}">
                        <td>
                            <div style="font-weight: 500;">{{ attendee.name }}</div>
                            <div class="text-muted text-small">{{ attendee.email }}</div>
                            {% if attendee.job_title %}
                                <div class="text-muted text-small">{{ attendee.job_title }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendee.has_voice %}
                                <div class="status status-active">
                                    <i class="fas fa-check-circle"></i>
                                    Ready
                                </div>
                            {% elif attendee.has_profile %}
                                <div class="status status-pending">
                                    <i class="fas fa-user"></i>
                                    Profile Only
                                </div>
                            {% else %}
                                <div class="status" style="background: #f5f5f5; color: #666;">
                                    <i class="fas fa-circle"></i>
                                    Not Set Up
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                {% if not attendee.has_voice %}
                                    <button onclick="sendInvitation('{{ attendee.email }}')" 
                                            class="btn btn-small btn-secondary">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                {% endif %}
                                <button onclick="removeAttendee('{{ attendee.email }}')" 
                                        class="btn btn-small" style="background: #fee; color: #c33;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="sendAllInvitations()" class="btn">
                    <i class="fas fa-envelope"></i>
                    Send All
                </button>
                <button onclick="refreshAttendees()" class="btn btn-secondary">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3 style="margin-bottom: 12px;">No attendees yet</h3>
                <p class="text-muted" style="margin-bottom: 24px;">Add attendees to get started with this meeting</p>
                <button onclick="showAddAttendeeModal()" class="btn">
                    <i class="fas fa-plus"></i>
                    Add First Attendee
                </button>
            </div>
        {% endif %}
    </div>
    
    <!-- Meeting Actions -->
    <div>
        <div class="card">
            <div class="flex-between mb-20">
                <h3 style="font-size: 18px; font-weight: 500;">Meeting Link</h3>
            </div>
            
            <div class="form-group">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="meetingUrl" 
                           value="{{ meeting_url }}" readonly 
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <button onclick="copyToClipboard('meetingUrl')" class="btn btn-small btn-secondary">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 16px;">
                <a href="{{ meeting_url }}" target="_blank" class="btn" style="width: 100%;">
                    <i class="fas fa-external-link-alt"></i>
                    Join Room
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="flex-between mb-20">
                <h3 style="font-size: 18px; font-weight: 500;">Actions</h3>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="{% url 'meetings_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </a>
                
                {% if meeting.is_completed and meeting.has_transcripts %}
                    <a href="{% url 'meeting_transcript' meeting.meeting_id %}" class="btn btn-primary">
                        <i class="fas fa-file-text"></i>
                        View Transcript & Minutes
                    </a>
                {% elif meeting.is_completed %}
                    <div class="alert alert-warning">
                        <i class="fas fa-clock"></i>
                        Meeting completed. Transcript processing...
                    </div>
                {% endif %}
                
                <button onclick="toggleMeetingStatus()" class="btn {% if meeting.is_active %}btn-secondary{% else %}btn-primary{% endif %}">
                    {% if meeting.is_active %}
                        <i class="fas fa-pause"></i>
                        Deactivate
                    {% else %}
                        <i class="fas fa-play"></i>
                        Activate
                    {% endif %}
                </button>
                
                <a href="{% url 'delete_meeting' meeting.meeting_id %}" 
                   class="btn" 
                   style="background: #fee; color: #c33;"
                   onclick="return confirm('Delete this meeting?')">
                    <i class="fas fa-trash"></i>
                    Delete
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Add Attendee Modal -->
<div id="addAttendeeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px;">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Add Attendees</h3>
            <button onclick="closeAddAttendeeModal()" class="btn btn-small btn-secondary">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="form-group">
            <label>Email Addresses</label>
            <textarea id="newAttendees" 
                      placeholder="john@company.com&#10;jane@company.com" 
                      rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="sendInvitesCheck" checked>
                Send voice setup invitations
            </label>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="addAttendees()" class="btn">
                <i class="fas fa-plus"></i>
                Add Attendees
            </button>
            <button onclick="closeAddAttendeeModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
function showAddAttendeeModal() {
    document.getElementById('addAttendeeModal').style.display = 'flex';
}

function closeAddAttendeeModal() {
    document.getElementById('addAttendeeModal').style.display = 'none';
    document.getElementById('newAttendees').value = '';
}

async function addAttendees() {
    const textarea = document.getElementById('newAttendees');
    const sendInvites = document.getElementById('sendInvitesCheck').checked;
    
    const emails = textarea.value.split('\n')
        .map(line => line.trim())
        .filter(line => line);
    
    if (emails.length === 0) {
        alert('Please enter at least one email address');
        return;
    }
    
    try {
        const response = await fetch('{% url "add_attendees" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                emails: emails,
                send_invites: sendInvites
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Successfully added ${data.added.length} attendees`);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function removeAttendee(email) {
    if (!confirm(`Remove ${email} from this meeting?`)) {
        return;
    }
    
    try {
        const response = await fetch('{% url "remove_attendee" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.querySelector(`tr[data-email="${email}"]`).remove();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function sendInvitation(email) {
    try {
        const response = await fetch('{% url "send_invitations" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ emails: [email] })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Invitation sent to ${email}`);
        } else {
            alert('Error sending invitation');
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function sendAllInvitations() {
    try {
        const response = await fetch('{% url "send_invitations" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ emails: [] }) // Empty means all who need setup
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Invitations sent to ${data.sent} attendees`);
        } else {
            alert('Error sending invitations');
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('Copied to clipboard!');
}

function refreshAttendees() {
    location.reload();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
document.getElementById('addAttendeeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddAttendeeModal();
    }
});

// ===== AGENDA MANAGEMENT =====

// Load agenda items
function loadAgenda() {
    fetch(`/api/meetings/{{ meeting.meeting_id }}/agenda/`)
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('agenda-items');
            const emptyState = document.getElementById('empty-agenda');

            if (data.agenda_items.length === 0) {
                container.innerHTML = '';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                renderAgendaItems(data.agenda_items);
                initializeDragAndDrop();
            }
        })
        .catch(error => console.error('Error loading agenda:', error));
}

// Render agenda items
function renderAgendaItems(items) {
    const container = document.getElementById('agenda-items');
    container.innerHTML = items.map(item => `
        <div class="agenda-item" data-id="${item.id}">
            <div class="agenda-handle">
                <i class="fas fa-grip-vertical"></i>
            </div>
            <div class="agenda-content">
                <div class="agenda-title">${item.title}</div>
                ${item.participant_name ? `<div class="agenda-participant">${item.participant_name}</div>` : ''}
            </div>
            <div class="agenda-actions">
                <button onclick="deleteAgendaItem(${item.id})" class="btn-icon" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Show add agenda modal
function showAddAgendaModal() {
    const modal = document.getElementById('addAgendaModal');
    modal.style.display = 'flex';
    document.getElementById('agendaTitle').focus();
}

// Close add agenda modal
function closeAddAgendaModal() {
    document.getElementById('addAgendaModal').style.display = 'none';
    document.getElementById('addAgendaForm').reset();
}

// Add agenda item
function addAgendaItem() {
    const form = document.getElementById('addAgendaForm');
    const formData = new FormData(form);

    fetch(`/api/meetings/{{ meeting.meeting_id }}/agenda/`, {
        method: 'POST',
        body: formData,
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            closeAddAgendaModal();
            loadAgenda();
        } else {
            alert(data.error || 'Failed to add agenda item');
        }
    })
    .catch(error => {
        console.error('Error adding agenda item:', error);
        alert('Error adding agenda item');
    });
}

// Delete agenda item
function deleteAgendaItem(itemId) {
    if (confirm('Delete this agenda item?')) {
        fetch(`/api/meetings/{{ meeting.meeting_id }}/agenda/${itemId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadAgenda();
            } else {
                alert(data.error || 'Failed to delete agenda item');
            }
        })
        .catch(error => {
            console.error('Error deleting agenda item:', error);
            alert('Error deleting agenda item');
        });
    }
}

// Initialize drag and drop
function initializeDragAndDrop() {
    const container = document.getElementById('agenda-items');
    let draggedElement = null;

    container.addEventListener('dragstart', function(e) {
        if (e.target.classList.contains('agenda-item')) {
            draggedElement = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }
    });

    container.addEventListener('dragend', function(e) {
        if (e.target.classList.contains('agenda-item')) {
            e.target.classList.remove('dragging');
            draggedElement = null;
        }
    });

    container.addEventListener('dragover', function(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        if (afterElement == null) {
            container.appendChild(draggedElement);
        } else {
            container.insertBefore(draggedElement, afterElement);
        }
    });

    container.addEventListener('drop', function(e) {
        e.preventDefault();
        updateAgendaOrder();
    });

    // Make items draggable
    const items = container.querySelectorAll('.agenda-item');
    items.forEach(item => {
        item.draggable = true;
    });
}

// Get element after drag position
function getDragAfterElement(container, y) {
    const draggableElements = [...container.querySelectorAll('.agenda-item:not(.dragging)')];

    return draggableElements.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;

        if (offset < 0 && offset > closest.offset) {
            return { offset: offset, element: child };
        } else {
            return closest;
        }
    }, { offset: Number.NEGATIVE_INFINITY }).element;
}

// Update agenda order after drag
function updateAgendaOrder() {
    const items = document.querySelectorAll('.agenda-item');
    const order = Array.from(items).map((item, index) => ({
        id: item.dataset.id,
        order: index
    }));

    fetch(`/api/meetings/{{ meeting.meeting_id }}/agenda/reorder/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({ order: order })
    })
    .catch(error => console.error('Error updating order:', error));
}

// Load agenda on page load
loadAgenda();
</script>

<!-- Add Agenda Modal -->
<div id="addAgendaModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Add Agenda Item</h3>
            <button onclick="closeAddAgendaModal()" class="btn-close">
                <i class="fas fa-times"></i>
            </button>
        </div>

        <form id="addAgendaForm" onsubmit="event.preventDefault(); addAgendaItem();">
            <div class="form-group">
                <label for="agendaTitle">Agenda Item Title</label>
                <input type="text" id="agendaTitle" name="title" required placeholder="e.g. Budget Review Q4">
            </div>

            <div class="form-group">
                <label for="agendaParticipant">Assigned To (Optional)</label>
                <select id="agendaParticipant" name="assigned_participant">
                    <option value="">No one assigned</option>
                    {% for attendee in attendee_status %}
                        <option value="{{ attendee.email }}">{{ attendee.name }} ({{ attendee.email }})</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-actions">
                <button type="button" onclick="closeAddAgendaModal()" class="btn-secondary">Cancel</button>
                <button type="submit" class="btn">Add Item</button>
            </div>
        </form>
    </div>
</div>

<style>
.agenda-items {
    min-height: 100px;
}

.agenda-item {
    display: flex;
    align-items: center;
    padding: 12px;
    margin-bottom: 8px;
    background: #f8f9fa;
    border: 1px solid #e9ecef;
    border-radius: 6px;
    cursor: move;
    transition: all 0.2s ease;
}

.agenda-item:hover {
    background: #e9ecef;
    border-color: #dee2e6;
}

.agenda-item.dragging {
    opacity: 0.5;
    transform: rotate(5deg);
}

.agenda-handle {
    margin-right: 12px;
    color: #666;
    cursor: grab;
}

.agenda-handle:active {
    cursor: grabbing;
}

.agenda-content {
    flex: 1;
}

.agenda-title {
    font-weight: 500;
    margin-bottom: 2px;
}

.agenda-participant {
    font-size: 12px;
    color: #666;
}

.agenda-actions {
    margin-left: 12px;
}

.btn-icon {
    background: none;
    border: none;
    padding: 6px;
    border-radius: 4px;
    cursor: pointer;
    color: #666;
    transition: all 0.2s ease;
}

.btn-icon:hover {
    background: #dc3545;
    color: white;
}
</style>
{% endblock %}