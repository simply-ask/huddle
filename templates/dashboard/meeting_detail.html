{% extends 'dashboard/base.html' %}

{% block title %}{{ meeting.title|default:"Meeting" }} - huddle{% endblock %}

{% block dashboard_content %}
<!-- Simple header with status -->
<div class="header">
    <div class="flex-between">
        <div>
            <h1 style="font-size: 20px; margin-bottom: 4px; font-weight: 500;">{{ meeting.title|default:"Untitled Meeting" }}</h1>
            <div class="text-muted text-small">Meeting {{ meeting.meeting_id }} â€¢ {{ meeting.created_at|date:"M j, Y" }}</div>
        </div>
        
        <div>
            {% if meeting.is_active %}
                <div class="status status-active">
                    <i class="fas fa-circle" style="font-size: 8px;"></i>
                    Active
                </div>
            {% else %}
                <div class="status status-completed">
                    <i class="fas fa-circle" style="font-size: 8px;"></i>
                    Inactive
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Simple stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 40px;">
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">{{ attendee_status|length }}</div>
        <div class="text-muted text-small">Attendees</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">
            {% for attendee in attendee_status %}{% if attendee.has_voice %}{{ forloop.counter }}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div class="text-muted text-small">Ready</div>
    </div>
    <div class="card" style="text-align: center; padding: 16px;">
        <div style="font-size: 20px; font-weight: 600;">
            {% for attendee in attendee_status %}{% if not attendee.has_voice %}{{ forloop.counter }}{% endif %}{% empty %}0{% endfor %}
        </div>
        <div class="text-muted text-small">Need Setup</div>
    </div>
</div>

<div style="display: grid; grid-template-columns: 2fr 1fr; gap: 30px;">
    <!-- Attendee Management -->
    <div class="card">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Attendees</h3>
            <button onclick="showAddAttendeeModal()" class="btn">
                <i class="fas fa-plus"></i>
                Add
            </button>
        </div>
        
        {% if attendee_status %}
            <table>
                <thead>
                    <tr>
                        <th>Attendee</th>
                        <th>Status</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    {% for attendee in attendee_status %}
                    <tr data-email="{{ attendee.email }}">
                        <td>
                            <div style="font-weight: 500;">{{ attendee.name }}</div>
                            <div class="text-muted text-small">{{ attendee.email }}</div>
                            {% if attendee.job_title %}
                                <div class="text-muted text-small">{{ attendee.job_title }}</div>
                            {% endif %}
                        </td>
                        <td>
                            {% if attendee.has_voice %}
                                <div class="status status-active">
                                    <i class="fas fa-check-circle"></i>
                                    Ready
                                </div>
                            {% elif attendee.has_profile %}
                                <div class="status status-pending">
                                    <i class="fas fa-user"></i>
                                    Profile Only
                                </div>
                            {% else %}
                                <div class="status" style="background: #f5f5f5; color: #666;">
                                    <i class="fas fa-circle"></i>
                                    Not Set Up
                                </div>
                            {% endif %}
                        </td>
                        <td>
                            <div style="display: flex; gap: 8px;">
                                {% if not attendee.has_voice %}
                                    <button onclick="sendInvitation('{{ attendee.email }}')" 
                                            class="btn btn-small btn-secondary">
                                        <i class="fas fa-envelope"></i>
                                    </button>
                                {% endif %}
                                <button onclick="removeAttendee('{{ attendee.email }}')" 
                                        class="btn btn-small" style="background: #fee; color: #c33;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button onclick="sendAllInvitations()" class="btn">
                    <i class="fas fa-envelope"></i>
                    Send All
                </button>
                <button onclick="refreshAttendees()" class="btn btn-secondary">
                    <i class="fas fa-sync"></i>
                    Refresh
                </button>
            </div>
        {% else %}
            <div style="text-align: center; padding: 60px 20px;">
                <i class="fas fa-users" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                <h3 style="margin-bottom: 12px;">No attendees yet</h3>
                <p class="text-muted" style="margin-bottom: 24px;">Add attendees to get started with this meeting</p>
                <button onclick="showAddAttendeeModal()" class="btn">
                    <i class="fas fa-plus"></i>
                    Add First Attendee
                </button>
            </div>
        {% endif %}
    </div>
    
    <!-- Meeting Actions -->
    <div>
        <div class="card">
            <div class="flex-between mb-20">
                <h3 style="font-size: 18px; font-weight: 500;">Meeting Link</h3>
            </div>
            
            <div class="form-group">
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="meetingUrl" 
                           value="{{ meeting_url }}" readonly 
                           style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                    <button onclick="copyToClipboard('meetingUrl')" class="btn btn-small btn-secondary">
                        <i class="fas fa-copy"></i>
                    </button>
                </div>
            </div>
            
            <div style="margin-top: 16px;">
                <a href="{{ meeting_url }}" target="_blank" class="btn" style="width: 100%;">
                    <i class="fas fa-external-link-alt"></i>
                    Join Room
                </a>
            </div>
        </div>
        
        <div class="card">
            <div class="flex-between mb-20">
                <h3 style="font-size: 18px; font-weight: 500;">Actions</h3>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <a href="{% url 'meetings_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i>
                    Back
                </a>
                
                {% if meeting.transcriptsegment_set.exists %}
                    <a href="{% url 'meeting_transcript' meeting.meeting_id %}" class="btn btn-secondary">
                        <i class="fas fa-file-text"></i>
                        View Transcript
                    </a>
                {% endif %}
                
                <button onclick="toggleMeetingStatus()" class="btn {% if meeting.is_active %}btn-secondary{% else %}btn-primary{% endif %}">
                    {% if meeting.is_active %}
                        <i class="fas fa-pause"></i>
                        Deactivate
                    {% else %}
                        <i class="fas fa-play"></i>
                        Activate
                    {% endif %}
                </button>
                
                <a href="{% url 'delete_meeting' meeting.meeting_id %}" 
                   class="btn" 
                   style="background: #fee; color: #c33;"
                   onclick="return confirm('Delete this meeting?')">
                    <i class="fas fa-trash"></i>
                    Delete
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Add Attendee Modal -->
<div id="addAttendeeModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div class="card" style="width: 90%; max-width: 500px;">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Add Attendees</h3>
            <button onclick="closeAddAttendeeModal()" class="btn btn-small btn-secondary">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="form-group">
            <label>Email Addresses</label>
            <textarea id="newAttendees" 
                      placeholder="john@company.com&#10;jane@company.com" 
                      rows="4" 
                      style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></textarea>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" id="sendInvitesCheck" checked>
                Send voice setup invitations
            </label>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button onclick="addAttendees()" class="btn">
                <i class="fas fa-plus"></i>
                Add Attendees
            </button>
            <button onclick="closeAddAttendeeModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
function showAddAttendeeModal() {
    document.getElementById('addAttendeeModal').style.display = 'flex';
}

function closeAddAttendeeModal() {
    document.getElementById('addAttendeeModal').style.display = 'none';
    document.getElementById('newAttendees').value = '';
}

async function addAttendees() {
    const textarea = document.getElementById('newAttendees');
    const sendInvites = document.getElementById('sendInvitesCheck').checked;
    
    const emails = textarea.value.split('\n')
        .map(line => line.trim())
        .filter(line => line);
    
    if (emails.length === 0) {
        alert('Please enter at least one email address');
        return;
    }
    
    try {
        const response = await fetch('{% url "add_attendees" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                emails: emails,
                send_invites: sendInvites
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Successfully added ${data.added.length} attendees`);
            location.reload();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function removeAttendee(email) {
    if (!confirm(`Remove ${email} from this meeting?`)) {
        return;
    }
    
    try {
        const response = await fetch('{% url "remove_attendee" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ email: email })
        });
        
        const data = await response.json();
        
        if (data.success) {
            document.querySelector(`tr[data-email="${email}"]`).remove();
        } else {
            alert('Error: ' + data.message);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function sendInvitation(email) {
    try {
        const response = await fetch('{% url "send_invitations" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ emails: [email] })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Invitation sent to ${email}`);
        } else {
            alert('Error sending invitation');
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function sendAllInvitations() {
    try {
        const response = await fetch('{% url "send_invitations" meeting.meeting_id %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ emails: [] }) // Empty means all who need setup
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Invitations sent to ${data.sent} attendees`);
        } else {
            alert('Error sending invitations');
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

function copyToClipboard(elementId) {
    const element = document.getElementById(elementId);
    element.select();
    element.setSelectionRange(0, 99999);
    document.execCommand('copy');
    alert('Copied to clipboard!');
}

function refreshAttendees() {
    location.reload();
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Close modal when clicking outside
document.getElementById('addAttendeeModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddAttendeeModal();
    }
});
</script>
{% endblock %}