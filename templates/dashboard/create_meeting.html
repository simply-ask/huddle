{% extends 'dashboard/base.html' %}

{% block title %}Create Meeting - huddle{% endblock %}

{% block extra_css %}
<style>
    /* Enhanced form styles for date/time inputs */
    input[type="date"],
    select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        font-size: 15px;
        font-family: inherit;
        border-radius: 8px;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    input[type="date"]:hover,
    select:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    input[type="date"]:focus,
    select:focus {
        outline: none;
        border-color: #64a93f;
        background: rgba(255, 255, 255, 0.05);
    }
    
    /* Style the calendar and time picker icons */
    input[type="date"]::-webkit-calendar-picker-indicator,
    input[type="time"]::-webkit-calendar-picker-indicator {
        filter: invert(0.8);
        cursor: pointer;
        opacity: 0;
        position: absolute;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
    }
    
    /* Make entire input clickable */
    input[type="date"],
    input[type="time"] {
        position: relative;
    }
    
    /* Custom time select dropdown */
    .time-select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        font-size: 15px;
        font-family: inherit;
        border-radius: 8px;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .time-select:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .time-select:focus {
        outline: none;
        border-color: #64a93f;
        background: rgba(255, 255, 255, 0.05);
    }
    
    /* Custom Flatpickr styling to match theme */
    .flatpickr-date {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        background: rgba(255, 255, 255, 0.03);
        color: #fff;
        font-size: 15px;
        font-family: inherit;
        border-radius: 8px;
        transition: all 0.2s;
        cursor: pointer;
    }
    
    .flatpickr-date:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
    }
    
    .flatpickr-date:focus {
        outline: none;
        border-color: #64a93f;
        background: rgba(255, 255, 255, 0.05);
    }
    
    /* Override Flatpickr dark theme colors to match our brand */
    .flatpickr-calendar.arrowTop:before {
        border-bottom-color: #0B2033;
    }
    
    .flatpickr-calendar.arrowTop:after {
        border-bottom-color: #0B2033;
    }
</style>
{% endblock %}

{% block dashboard_content %}

<div style="max-width: 600px;">
    <!-- Simple header -->
    <div class="mb-40">
        <h1 style="font-size: 24px; font-weight: 500; margin-bottom: 8px;">Create Meeting</h1>
        <p class="text-muted">Set up a new meeting session</p>
    </div>

    <!-- Simple form -->
    <form method="post" class="card">
        {% csrf_token %}
        
        <div class="form-group">
            <label for="title">Meeting Title</label>
            <input type="text" id="title" name="title" 
                   placeholder="Weekly standup" 
                   value="{{ title|default:'' }}" required>
        </div>
        
        <!-- Date and Time -->
        <div class="form-group">
            <label for="scheduled_date">Date</label>
            <input type="text" id="scheduled_date" name="scheduled_date" 
                   placeholder="Select date" class="flatpickr-date"
                   value="{{ scheduled_date|default:'' }}" required>
        </div>
        
        <div class="form-group">
            <label for="scheduled_time">Time</label>
            <div style="display: flex; gap: 8px; align-items: center;">
                <select id="scheduled_hour" name="scheduled_hour" class="time-select" style="width: 100px;" required>
                    <option value="">Hour</option>
                </select>
                <span style="font-size: 20px; color: rgba(255, 255, 255, 0.5);">:</span>
                <select id="scheduled_minute" name="scheduled_minute" class="time-select" style="width: 100px;" required>
                    <option value="">Min</option>
                    <option value="00">00</option>
                    <option value="15">15</option>
                    <option value="30">30</option>
                    <option value="45">45</option>
                </select>
                <span id="time_display" class="text-muted" style="margin-left: 16px; font-size: 14px;"></span>
            </div>
            <!-- Hidden input to maintain backward compatibility -->
            <input type="hidden" id="scheduled_time" name="scheduled_time">
        </div>
        
        <!-- Location -->
        <div class="form-group">
            <label for="location">Location <span class="text-muted text-small">(Optional)</span></label>
            <input type="text" id="location" name="location" 
                   placeholder="e.g., Conference Room B, 3rd Floor" 
                   value="{{ location|default:'' }}">
        </div>
        
        <div class="form-group">
            <label for="attendees">Attendees</label>
            <textarea id="attendees" name="attendees" 
                      placeholder="john@company.com&#10;jane@company.com" 
                      rows="4">{{ attendees|default:'' }}</textarea>
            <div class="text-muted text-small" style="margin-top: 4px;">
                <i class="fas fa-info-circle"></i>
                Enter email addresses, one per line
            </div>
        </div>
        
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                <input type="checkbox" name="send_invites" {% if not attendees %}checked{% endif %}>
                Send invitations now
            </label>
        </div>
        
        <div class="flex gap-10">
            <button type="submit" class="btn">
                <i class="fas fa-plus"></i>
                Create Meeting
            </button>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i>
                Back
            </a>
        </div>
    </form>
    
    <!-- Quick add from existing attendees -->
    {% if suggested_speakers %}
    <div class="card">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">Quick Add</h3>
            <div class="text-muted text-small">Previous attendees</div>
        </div>
        
        <div style="display: flex; flex-wrap: gap: 8px;">
            {% for speaker in suggested_speakers %}
            <button type="button" class="btn btn-small btn-secondary" 
                    onclick="addSpeaker('{{ speaker.email }}', '{{ speaker.full_name }}')"
                    style="font-size: 13px;">
                <i class="fas fa-plus"></i>
                {{ speaker.full_name }}
            </button>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    
    <!-- Simple help -->
    <div class="card">
        <div class="flex gap-20">
            <div>
                <div class="flex gap-10 mb-10">
                    <i class="fas fa-envelope"></i>
                    <span style="font-weight: 500;">Email Setup</span>
                </div>
                <div class="text-muted text-small">Attendees get voice setup links</div>
            </div>
            
            <div>
                <div class="flex gap-10 mb-10">
                    <i class="fas fa-microphone"></i>
                    <span style="font-weight: 500;">Voice Samples</span>
                </div>
                <div class="text-muted text-small">10-15 seconds for ID</div>
            </div>
            
            <div>
                <div class="flex gap-10 mb-10">
                    <i class="fas fa-phone"></i>
                    <span style="font-weight: 500;">Recording</span>
                </div>
                <div class="text-muted text-small">Single device captures all</div>
            </div>
        </div>
    </div>
</div>

<script>
// Generate hour options (00-23)
function generateHourOptions() {
    const hourSelect = document.getElementById('scheduled_hour');
    const savedTime = '{{ scheduled_time|default:"" }}';
    const savedHour = savedTime ? savedTime.split(':')[0] : '';
    
    for (let hour = 0; hour < 24; hour++) {
        const hourStr = String(hour).padStart(2, '0');
        const option = document.createElement('option');
        option.value = hourStr;
        option.textContent = hourStr;
        
        if (hourStr === savedHour) {
            option.selected = true;
        }
        
        hourSelect.appendChild(option);
    }
}

// Update the time display and hidden input
function updateTimeDisplay() {
    const hourSelect = document.getElementById('scheduled_hour');
    const minuteSelect = document.getElementById('scheduled_minute');
    const timeDisplay = document.getElementById('time_display');
    const hiddenTimeInput = document.getElementById('scheduled_time');
    
    if (hourSelect.value && minuteSelect.value) {
        const hour = parseInt(hourSelect.value);
        const minute = minuteSelect.value;
        
        // Update hidden input for form submission
        hiddenTimeInput.value = `${hourSelect.value}:${minute}`;
        
        // Create friendly display (12-hour format)
        let displayHour = hour;
        let period = 'AM';
        
        if (hour === 0) {
            displayHour = 12;
        } else if (hour === 12) {
            period = 'PM';
        } else if (hour > 12) {
            displayHour = hour - 12;
            period = 'PM';
        }
        
        timeDisplay.textContent = `${displayHour}:${minute} ${period}`;
    } else {
        timeDisplay.textContent = '';
        hiddenTimeInput.value = '';
    }
}

// Set smart defaults for time
function setTimeDefaults() {
    const hourSelect = document.getElementById('scheduled_hour');
    const minuteSelect = document.getElementById('scheduled_minute');
    const savedTime = '{{ scheduled_time|default:"" }}';
    
    if (savedTime) {
        // Use saved values
        const [hour, minute] = savedTime.split(':');
        hourSelect.value = hour;
        minuteSelect.value = minute;
    } else {
        // Set smart defaults
        const now = new Date();
        let nextHour = now.getHours();
        let nextMinute = Math.ceil(now.getMinutes() / 15) * 15;
        
        // If we've passed 45 minutes, go to next hour
        if (nextMinute === 60) {
            nextHour = (nextHour + 1) % 24;
            nextMinute = 0;
        }
        
        hourSelect.value = String(nextHour).padStart(2, '0');
        minuteSelect.value = String(nextMinute).padStart(2, '0');
    }
    
    updateTimeDisplay();
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    generateHourOptions();
    setTimeDefaults();
    
    // Initialize Flatpickr date picker
    const savedDate = '{{ scheduled_date|default:"" }}';
    const today = new Date();
    
    flatpickr("#scheduled_date", {
        theme: "dark",
        dateFormat: "Y-m-d",
        defaultDate: savedDate || today,
        minDate: "today",
        inline: false,
        allowInput: false,
        disableMobile: false,
        locale: {
            firstDayOfWeek: 1 // Start week on Monday
        }
    });
    
    // Add event listeners for time changes
    document.getElementById('scheduled_hour').addEventListener('change', updateTimeDisplay);
    document.getElementById('scheduled_minute').addEventListener('change', updateTimeDisplay);
});

function addSpeaker(email, name) {
    const attendeesField = document.getElementById('attendees');
    const currentValue = attendeesField.value.trim();
    
    // Check if email already exists
    if (currentValue.includes(email)) {
        return;
    }
    
    // Add the email
    const newValue = currentValue ? currentValue + '\n' + email : email;
    attendeesField.value = newValue;
    
    // Visual feedback
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-check"></i> Added';
    button.style.background = '#e8f5e8';
    button.style.color = '#2e7d32';
    
    setTimeout(() => {
        button.innerHTML = originalText;
        button.style.background = '';
        button.style.color = '';
    }, 1500);
}
</script>

{% endblock %}