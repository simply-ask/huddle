{% extends 'base.html' %}
{% load static %}

{% block title %}Voice Setup - {{ meeting.title|default:meeting.meeting_id }}{% endblock %}

{% block extra_css %}
<style>
    /* Override base styles for consistent theme */
    body {
        background: #0B2033;
        min-height: 100vh;
    }
    
    .voice-setup-container {
        max-width: 600px;
        margin: 0 auto;
        padding: 40px 20px;
    }
    
    /* Recording area styles */
    .voice-recording {
        background: rgba(255, 255, 255, 0.08);
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 12px;
        padding: 32px;
        text-align: center;
        transition: all 0.3s ease;
    }
    
    .voice-recording.recording {
        background: rgba(220, 53, 69, 0.15);
        border-color: #dc3545;
        animation: pulse-border 2s infinite;
    }
    
    @keyframes pulse-border {
        0% { border-color: rgba(220, 53, 69, 0.5); }
        50% { border-color: rgba(220, 53, 69, 1); }
        100% { border-color: rgba(220, 53, 69, 0.5); }
    }
    
    .voice-recording h4 {
        font-size: 18px;
        font-weight: 500;
        margin-bottom: 16px;
        color: #fff;
    }
    
    .voice-recording p {
        color: rgba(255, 255, 255, 0.8);
        margin-bottom: 24px;
    }
    
    .voice-recording em {
        display: block;
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 6px;
        margin: 16px 0;
        font-style: normal;
        color: rgba(255, 255, 255, 0.9);
    }
    
    /* Recording timer */
    #recordingTimer {
        font-size: 24px;
        font-weight: 300;
        margin-top: 16px;
        color: #fff;
        font-variant-numeric: tabular-nums;
    }
    
    /* Audio preview */
    .audio-preview {
        width: 100%;
        margin: 16px 0;
        filter: invert(1) brightness(0.9);
    }
    
    /* Instructions card */
    .instructions-card {
        background: rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 24px;
    }
    
    .instructions-card h3 {
        font-size: 16px;
        font-weight: 500;
        margin-bottom: 12px;
        color: #fff;
    }
    
    .instructions-card ul {
        list-style: none;
        padding: 0;
    }
    
    .instructions-card li {
        padding: 8px 0;
        color: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    
    .instructions-card li:before {
        content: "âœ“";
        color: #64a93f;
        font-weight: bold;
    }
    
    /* Custom button styles for recording */
    .btn-record {
        background: #dc3545;
        min-width: 180px;
    }
    
    .btn-record:hover {
        background: #c82333;
    }
    
    .btn-rerecord {
        background: rgba(255, 255, 255, 0.2);
    }
    
    .btn-rerecord:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    /* Error message styling */
    .error-alert {
        background: rgba(220, 53, 69, 0.9);
        color: #fff;
        padding: 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
</style>
{% endblock %}

{% block content %}
<div class="voice-setup-container">
    <!-- Header with logo -->
    <div class="mb-40" style="text-align: center;">
        <a href="/">
            <img src="/static/images/huddle_logo_transparent.svg" alt="huddle" style="height: 60px; margin-bottom: 20px;">
        </a>
        <h1 style="font-size: 32px; font-weight: 300; margin-bottom: 8px; color: #fff;">Voice Setup</h1>
        <p class="text-muted">Create your voice profile for speaker identification</p>
    </div>

    <!-- Meeting info card -->
    <div class="card">
        <div class="flex-between mb-20">
            <h3 style="font-size: 18px; font-weight: 500;">{{ meeting.title|default:"Upcoming Meeting" }}</h3>
            <span class="status status-active">
                <i class="fas fa-video"></i>
                Ready
            </span>
        </div>
        <div class="flex gap-20" style="flex-wrap: wrap;">
            <div>
                <div class="text-small text-muted">Meeting ID</div>
                <div style="font-weight: 500;">{{ meeting.meeting_id }}</div>
            </div>
            <div>
                <div class="text-small text-muted">Host</div>
                <div style="font-weight: 500;">{{ meeting.host.get_full_name|default:meeting.host.username|default:"Host" }}</div>
            </div>
            <div>
                <div class="text-small text-muted">Your Email</div>
                <div style="font-weight: 500;">{{ email }}</div>
            </div>
        </div>
    </div>

    <!-- Instructions -->
    <div class="instructions-card">
        <h3><i class="fas fa-info-circle"></i> Quick Setup Guide</h3>
        <ul>
            <li>Record a 10-15 second voice sample</li>
            <li>Speak naturally and clearly</li>
            <li>Find a quiet environment</li>
            <li>Your profile works for all future meetings</li>
        </ul>
    </div>

    <div id="errorMessage" class="error-alert" style="display: none;">
        <i class="fas fa-exclamation-circle"></i>
        <span></span>
    </div>

    <form id="voiceSetupForm" method="post" action="/meet/{{ meeting.meeting_id }}/voice-setup-process/" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="email" value="{{ email }}">
        <input type="hidden" name="token" value="{{ token }}">
        
        <div class="form-group">
            <label for="full_name">Full Name</label>
            <input type="text" id="full_name" name="full_name" 
                   value="{{ suggested_name }}" required>
        </div>

        <div class="form-group">
            <label for="job_title">Job Title <span class="text-muted text-small">(Optional)</span></label>
            <input type="text" id="job_title" name="job_title" 
                   placeholder="e.g., Software Engineer, Product Manager">
        </div>

        <div class="form-group">
            <label>Voice Sample</label>
            <div class="voice-recording" id="recordingArea">
                <div id="recordingInstructions">
                    <h4><i class="fas fa-microphone"></i> Record Your Voice</h4>
                    <p>Please say:</p>
                    <em>"Hello, my name is {{ suggested_name }}. I'm joining the meeting and look forward to our discussion."</em>
                    <button type="button" id="startRecordBtn" class="btn btn-record">
                        <i class="fas fa-circle"></i>
                        Start Recording
                    </button>
                </div>
                
                <div id="recordingActive" style="display: none;">
                    <h4><i class="fas fa-circle" style="color: #dc3545;"></i> Recording in Progress</h4>
                    <p>Please say:</p>
                    <em>"Hello, my name is {{ suggested_name }}. I'm joining the meeting and look forward to our discussion."</em>
                    <div id="recordingTimer">00:00</div>
                    <button type="button" id="stopRecordBtn" class="btn">
                        <i class="fas fa-stop"></i>
                        Stop Recording
                    </button>
                </div>
                
                <div id="recordingComplete" style="display: none;">
                    <h4><i class="fas fa-check-circle" style="color: #64a93f;"></i> Recording Complete</h4>
                    <audio id="audioPreview" controls class="audio-preview"></audio>
                    <button type="button" id="reRecordBtn" class="btn btn-rerecord">
                        <i class="fas fa-redo"></i>
                        Record Again
                    </button>
                </div>
            </div>
            <input type="file" id="voice_sample" name="voice_sample" style="display: none;" accept="audio/*">
        </div>

        <button type="submit" id="submitBtn" class="btn" disabled style="width: 100%;">
            <i class="fas fa-check"></i>
            Complete Setup
        </button>
    </form>
</div>

<script>
let mediaRecorder;
let audioChunks = [];
let recordingTimer;
let recordingStartTime;
let isRecording = false;

document.addEventListener('DOMContentLoaded', function() {
    const startBtn = document.getElementById('startRecordBtn');
    const stopBtn = document.getElementById('stopRecordBtn');
    const reRecordBtn = document.getElementById('reRecordBtn');
    const submitBtn = document.getElementById('submitBtn');
    const form = document.getElementById('voiceSetupForm');
    const errorDiv = document.getElementById('errorMessage');
    
    startBtn.addEventListener('click', startRecording);
    stopBtn.addEventListener('click', stopRecording);
    reRecordBtn.addEventListener('click', resetRecording);
    form.addEventListener('submit', handleSubmit);
    
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ 
                audio: {
                    echoCancellation: true,
                    noiseSuppression: true,
                    sampleRate: 44100
                }
            });
            
            mediaRecorder = new MediaRecorder(stream, {
                mimeType: 'audio/webm;codecs=opus'
            });
            
            audioChunks = [];
            
            mediaRecorder.ondataavailable = event => {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = () => {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                const audioUrl = URL.createObjectURL(audioBlob);
                
                const audioPreview = document.getElementById('audioPreview');
                audioPreview.src = audioUrl;
                
                // Convert blob to file for form submission
                const file = new File([audioBlob], 'voice_sample.webm', { type: 'audio/webm' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                document.getElementById('voice_sample').files = dataTransfer.files;
                
                showRecordingComplete();
                submitBtn.disabled = false;
            };
            
            mediaRecorder.start();
            isRecording = true;
            showRecordingActive();
            startTimer();
            
        } catch (error) {
            console.error('Error accessing microphone:', error);
            showError('Could not access your microphone. Please check permissions and try again.');
        }
    }
    
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
            isRecording = false;
            stopTimer();
        }
    }
    
    function resetRecording() {
        if (isRecording) {
            stopRecording();
        }
        audioChunks = [];
        document.getElementById('voice_sample').value = '';
        submitBtn.disabled = true;
        showRecordingInstructions();
    }
    
    function showRecordingInstructions() {
        document.getElementById('recordingInstructions').style.display = 'block';
        document.getElementById('recordingActive').style.display = 'none';
        document.getElementById('recordingComplete').style.display = 'none';
        document.getElementById('recordingArea').classList.remove('recording');
    }
    
    function showRecordingActive() {
        document.getElementById('recordingInstructions').style.display = 'none';
        document.getElementById('recordingActive').style.display = 'block';
        document.getElementById('recordingComplete').style.display = 'none';
        document.getElementById('recordingArea').classList.add('recording');
    }
    
    function showRecordingComplete() {
        document.getElementById('recordingInstructions').style.display = 'none';
        document.getElementById('recordingActive').style.display = 'none';
        document.getElementById('recordingComplete').style.display = 'block';
        document.getElementById('recordingArea').classList.remove('recording');
    }
    
    function startTimer() {
        recordingStartTime = Date.now();
        recordingTimer = setInterval(updateTimer, 1000);
    }
    
    function stopTimer() {
        if (recordingTimer) {
            clearInterval(recordingTimer);
        }
    }
    
    function updateTimer() {
        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60);
        const seconds = elapsed % 60;
        document.getElementById('recordingTimer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    function showError(message) {
        errorDiv.querySelector('span').textContent = message;
        errorDiv.style.display = 'flex';
        setTimeout(() => {
            errorDiv.style.display = 'none';
        }, 5000);
    }
    
    async function handleSubmit(e) {
        e.preventDefault();
        
        const fullName = document.getElementById('full_name').value.trim();
        const voiceFile = document.getElementById('voice_sample').files[0];
        
        if (!fullName) {
            showError('Please enter your full name.');
            return;
        }
        
        if (!voiceFile) {
            showError('Please record a voice sample.');
            return;
        }
        
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Setting up your profile...';
        
        try {
            const formData = new FormData(form);
            const response = await fetch(form.action || window.location.pathname, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const result = await response.json();
            
            if (response.ok && result.success) {
                // Redirect to success page
                window.location.href = window.location.pathname.replace('/voice-setup/', '/voice-setup-complete/') + window.location.search;
            } else {
                showError(result.error || 'An error occurred. Please try again.');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-check"></i> Complete Setup';
            }
            
        } catch (error) {
            console.error('Error submitting form:', error);
            showError('Network error. Please check your connection and try again.');
            submitBtn.disabled = false;
            submitBtn.textContent = 'ðŸš€ Complete Voice Setup';
        }
    }
});
</script>
{% endblock %}