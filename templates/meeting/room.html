{% extends 'base.html' %}
{% load static %}

{% block title %}Meeting: {{ meeting.title|default:meeting.meeting_id }}{% endblock %}

{% block extra_head %}
<style>
    .meeting-room {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    .participants-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
        gap: 20px;
        margin: 20px 0;
    }
    .participant-card {
        background: #f5f5f5;
        border-radius: 8px;
        padding: 15px;
        text-align: center;
    }
    .participant-status {
        display: inline-block;
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 5px;
    }
    .status-active { background: #4CAF50; }
    .status-recording { background: #FF5722; }
    .status-idle { background: #FFC107; }
    .controls {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-top: 1px solid #ddd;
        padding: 20px;
        display: flex;
        justify-content: center;
        gap: 20px;
    }
    .btn {
        padding: 12px 24px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        transition: all 0.3s;
    }
    .btn-record {
        background: #4CAF50;
        color: white;
    }
    .btn-record:hover {
        background: #45a049;
    }
    .btn-stop {
        background: #f44336;
        color: white;
    }
    .btn-leave {
        background: #9E9E9E;
        color: white;
    }
    .recording-indicator {
        position: fixed;
        top: 20px;
        right: 20px;
        background: #f44336;
        color: white;
        padding: 10px 20px;
        border-radius: 20px;
        display: none;
        align-items: center;
        gap: 10px;
    }
    .recording-indicator.active {
        display: flex;
    }
    .pulse {
        width: 10px;
        height: 10px;
        background: white;
        border-radius: 50%;
        animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }
    .transcript-container {
        background: #f9f9f9;
        border-radius: 8px;
        padding: 20px;
        margin: 20px 0;
        max-height: 300px;
        overflow-y: auto;
    }
    .transcript-segment {
        margin: 10px 0;
        padding: 10px;
        background: white;
        border-radius: 4px;
    }
    .speaker-label {
        font-weight: bold;
        color: #333;
        margin-bottom: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="meeting-room">
    <div class="recording-indicator" id="recordingIndicator">
        <div class="pulse"></div>
        <span>Recording</span>
    </div>

    <h1>{{ meeting.title|default:"Meeting" }}</h1>
    <p>Meeting ID: <strong>{{ meeting.meeting_id }}</strong></p>
    <p>Status: <span id="meetingStatus">{{ meeting.status }}</span></p>

    <div class="participants-section">
        <h2>Participants</h2>
        <div class="participants-grid" id="participantsGrid">
            <!-- Participants will be added dynamically -->
        </div>
    </div>

    <div class="transcript-container" id="transcriptContainer">
        <h3>Live Transcript</h3>
        <div id="transcriptContent">
            <p style="color: #999;">Transcript will appear here when recording starts...</p>
        </div>
    </div>

    <div class="controls">
        <button id="startRecordingBtn" class="btn btn-record">
            Start Recording
        </button>
        <button id="stopRecordingBtn" class="btn btn-stop" style="display: none;">
            Stop Recording
        </button>
        <button id="leaveMeetingBtn" class="btn btn-leave">
            Leave Meeting
        </button>
    </div>
</div>

<script>
    const meetingId = "{{ meeting.meeting_id }}";
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws/meeting/${meetingId}/`;
    
    let socket = null;
    let mediaRecorder = null;
    let audioChunks = [];
    let isRecording = false;

    // Initialize WebSocket connection
    function connectWebSocket() {
        socket = new WebSocket(wsUrl);
        
        socket.onopen = function(e) {
            console.log('WebSocket connected');
            socket.send(JSON.stringify({
                'type': 'join',
                'meeting_id': meetingId,
                'device_type': detectDeviceType()
            }));
        };
        
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            handleWebSocketMessage(data);
        };
        
        socket.onclose = function(e) {
            console.log('WebSocket disconnected');
            setTimeout(connectWebSocket, 3000); // Reconnect after 3 seconds
        };
        
        socket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
    }

    // Handle incoming WebSocket messages
    function handleWebSocketMessage(data) {
        switch(data.type) {
            case 'participant_joined':
                addParticipant(data.participant);
                break;
            case 'participant_left':
                removeParticipant(data.participant_id);
                break;
            case 'recording_started':
                updateRecordingStatus(true, data.participant_id);
                break;
            case 'recording_stopped':
                updateRecordingStatus(false, data.participant_id);
                break;
            case 'transcript_update':
                updateTranscript(data.transcript);
                break;
            case 'meeting_status':
                updateMeetingStatus(data.status);
                break;
        }
    }

    // Add participant to the grid
    function addParticipant(participant) {
        const grid = document.getElementById('participantsGrid');
        const card = document.createElement('div');
        card.className = 'participant-card';
        card.id = `participant-${participant.id}`;
        card.innerHTML = `
            <span class="participant-status status-idle"></span>
            <h4>${participant.name || 'Anonymous'}</h4>
            <p>${participant.device_type}</p>
        `;
        grid.appendChild(card);
    }

    // Remove participant from the grid
    function removeParticipant(participantId) {
        const card = document.getElementById(`participant-${participantId}`);
        if (card) {
            card.remove();
        }
    }

    // Update recording status
    function updateRecordingStatus(isRecording, participantId) {
        const indicator = document.getElementById('recordingIndicator');
        if (isRecording) {
            indicator.classList.add('active');
        } else {
            indicator.classList.remove('active');
        }
        
        // Update participant status
        const card = document.getElementById(`participant-${participantId}`);
        if (card) {
            const status = card.querySelector('.participant-status');
            status.className = `participant-status ${isRecording ? 'status-recording' : 'status-idle'}`;
        }
    }

    // Update transcript
    function updateTranscript(transcript) {
        const content = document.getElementById('transcriptContent');
        const segment = document.createElement('div');
        segment.className = 'transcript-segment';
        segment.innerHTML = `
            <div class="speaker-label">${transcript.speaker || 'Speaker'}</div>
            <div>${transcript.text}</div>
        `;
        content.appendChild(segment);
        
        // Auto-scroll to bottom
        const container = document.getElementById('transcriptContainer');
        container.scrollTop = container.scrollHeight;
    }

    // Update meeting status
    function updateMeetingStatus(status) {
        document.getElementById('meetingStatus').textContent = status;
    }

    // Detect device type
    function detectDeviceType() {
        const userAgent = navigator.userAgent.toLowerCase();
        if (/iphone|ipod|android.*mobile|windows phone/i.test(userAgent)) {
            return 'mobile';
        } else if (/ipad|android(?!.*mobile)/i.test(userAgent)) {
            return 'tablet';
        }
        return 'desktop';
    }

    // Start recording
    async function startRecording() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            
            mediaRecorder.ondataavailable = function(event) {
                if (event.data.size > 0) {
                    audioChunks.push(event.data);
                }
            };
            
            mediaRecorder.onstop = function() {
                const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                uploadAudio(audioBlob);
                audioChunks = [];
            };
            
            mediaRecorder.start();
            isRecording = true;
            
            // Update UI
            document.getElementById('startRecordingBtn').style.display = 'none';
            document.getElementById('stopRecordingBtn').style.display = 'inline-block';
            document.getElementById('recordingIndicator').classList.add('active');
            
            // Notify server
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    'type': 'recording_started',
                    'meeting_id': meetingId
                }));
            }
        } catch (error) {
            console.error('Error starting recording:', error);
            alert('Could not access microphone. Please check permissions.');
        }
    }

    // Stop recording
    function stopRecording() {
        if (mediaRecorder && isRecording) {
            mediaRecorder.stop();
            isRecording = false;
            
            // Update UI
            document.getElementById('startRecordingBtn').style.display = 'inline-block';
            document.getElementById('stopRecordingBtn').style.display = 'none';
            document.getElementById('recordingIndicator').classList.remove('active');
            
            // Notify server
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    'type': 'recording_stopped',
                    'meeting_id': meetingId
                }));
            }
            
            // Stop all tracks
            mediaRecorder.stream.getTracks().forEach(track => track.stop());
        }
    }

    // Upload audio to server
    async function uploadAudio(audioBlob) {
        const formData = new FormData();
        formData.append('audio', audioBlob, 'recording.webm');
        formData.append('meeting_id', meetingId);
        
        try {
            const response = await fetch('/api/upload-audio/', {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': getCookie('csrftoken')
                }
            });
            
            if (response.ok) {
                console.log('Audio uploaded successfully');
            } else {
                console.error('Failed to upload audio');
            }
        } catch (error) {
            console.error('Error uploading audio:', error);
        }
    }

    // Get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Leave meeting
    function leaveMeeting() {
        if (isRecording) {
            stopRecording();
        }
        
        if (socket) {
            socket.send(JSON.stringify({
                'type': 'leave',
                'meeting_id': meetingId
            }));
            socket.close();
        }
        
        window.location.href = '/';
    }

    // Event listeners
    document.getElementById('startRecordingBtn').addEventListener('click', startRecording);
    document.getElementById('stopRecordingBtn').addEventListener('click', stopRecording);
    document.getElementById('leaveMeetingBtn').addEventListener('click', leaveMeeting);

    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        connectWebSocket();
        
        // Request notification permission for meeting alerts
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    });

    // Handle page unload
    window.addEventListener('beforeunload', function() {
        if (isRecording) {
            stopRecording();
        }
        if (socket) {
            socket.close();
        }
    });
</script>
{% endblock %}