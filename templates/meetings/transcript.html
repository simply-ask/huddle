{% extends "base.html" %}

{% block title %}Transcript - {{ meeting.title }} | huddle{% endblock %}

{% block content %}

<!-- Simple header with back link -->
<div class="header">
    <div class="flex-between">
        <div>
            <a href="{% url 'meeting_detail' meeting.meeting_id %}" class="text-muted" style="text-decoration: none; margin-bottom: 8px; display: inline-block;">
                <i class="fas fa-arrow-left"></i>
                Back to meeting
            </a>
            <h1 style="font-size: 20px; margin-bottom: 4px; font-weight: 500;">{{ meeting.title|default:"Untitled Meeting" }}</h1>
            <div class="text-muted text-small">Meeting {{ meeting.meeting_id }}</div>
        </div>
        
        <!-- Processing status -->
        <div>
            {% if processing_status.processed_recordings < processing_status.total_recordings %}
                <div class="status status-pending">
                    <i class="fas fa-clock"></i>
                    Processing {{ processing_status.processed_recordings }}/{{ processing_status.total_recordings }}
                </div>
            {% elif not processing_status.ai_processing_complete %}
                <div class="status status-pending">
                    <i class="fas fa-brain fa-spin"></i>
                    AI Processing
                </div>
            {% else %}
                <div class="status status-active">
                    <i class="fas fa-check-circle"></i>
                    Complete
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if all_segments %}
    <!-- Simple stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 40px;">
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ total_segments }}</div>
            <div class="text-muted text-small">Segments</div>
        </div>
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ grouped_segments|length }}</div>
            <div class="text-muted text-small">Speakers</div>
        </div>
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ processing_status.processed_recordings }}</div>
            <div class="text-muted text-small">Recordings</div>
        </div>
    </div>

    {% if has_ai_processed %}
        <!-- AI-Processed Meeting Minutes -->
        <div class="card">
            <div class="flex gap-10 mb-20" style="align-items: center;">
                <i class="fas fa-brain" style="color: #007bff;"></i>
                <h2 style="font-size: 18px; font-weight: 600; margin: 0;">Meeting Minutes</h2>
                <div class="status status-active" style="margin-left: auto;">
                    <i class="fas fa-sparkles"></i>
                    AI Processed
                </div>
            </div>

            <!-- Executive Summary -->
            {% if summary.executive_summary %}
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: #495057;">
                        <i class="fas fa-file-alt"></i>
                        Executive Summary
                    </h3>
                    <div style="line-height: 1.7; padding: 16px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #007bff;">
                        {{ summary.executive_summary }}
                    </div>
                </div>
            {% endif %}

            <!-- Key Points -->
            {% if summary.key_points %}
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #495057;">
                        <i class="fas fa-lightbulb"></i>
                        Key Discussion Points
                    </h3>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.7;">
                        {% for point in summary.key_points %}
                            <li style="margin-bottom: 8px;">{{ point }}</li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- Action Items -->
            {% if summary.action_items %}
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #495057;">
                        <i class="fas fa-tasks"></i>
                        Action Items
                    </h3>
                    <div style="display: grid; gap: 12px;">
                        {% for item in summary.action_items %}
                            <div style="padding: 16px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
                                <div style="font-weight: 500; margin-bottom: 4px;">{{ item.task }}</div>
                                <div class="text-muted text-small">
                                    {% if item.owner and item.owner != "TBD" %}
                                        <i class="fas fa-user"></i> {{ item.owner }}
                                    {% endif %}
                                    {% if item.due_date and item.due_date != "TBD" %}
                                        • <i class="fas fa-calendar"></i> {{ item.due_date }}
                                    {% endif %}
                                    {% if item.priority %}
                                        • <i class="fas fa-flag"></i> {{ item.priority|title }}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Decisions Made -->
            {% if summary.decisions_made %}
                <div style="margin-bottom: 32px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #495057;">
                        <i class="fas fa-check-circle"></i>
                        Decisions Made
                    </h3>
                    <ul style="margin: 0; padding-left: 20px; line-height: 1.7;">
                        {% for decision in summary.decisions_made %}
                            <li style="margin-bottom: 8px; padding: 8px; background: #d1e7dd; border-radius: 4px; list-style: none; margin-left: -20px; padding-left: 20px;">
                                <i class="fas fa-check" style="color: #198754; margin-right: 8px;"></i>
                                {{ decision }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            {% endif %}

            <!-- Clean Transcript Toggle -->
            <div style="border-top: 1px solid #dee2e6; padding-top: 20px;">
                <button onclick="toggleTranscript()" class="btn-secondary" style="margin-bottom: 20px;">
                    <i class="fas fa-eye"></i>
                    <span id="transcript-toggle-text">Show Full Transcript</span>
                </button>

                <div id="full-transcript" style="display: none;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 16px; color: #495057;">
                        <i class="fas fa-file-text"></i>
                        Full Transcript
                    </h3>
                    <div style="line-height: 1.7; white-space: pre-line; padding: 20px; background: #f8f9fa; border-radius: 8px; max-height: 400px; overflow-y: auto;">{{ summary.clean_transcript }}</div>
                </div>
            </div>
        </div>
    {% else %}
        <!-- Raw Transcript (Fallback) -->
        <div class="card">
            <div class="flex gap-10 mb-20" style="align-items: center;">
                <i class="fas fa-file-text"></i>
                <h2 style="font-size: 18px; font-weight: 600; margin: 0;">Transcript</h2>
                {% if not processing_status.ai_processing_complete %}
                    <div class="status status-pending" style="margin-left: auto;">
                        <i class="fas fa-brain fa-spin"></i>
                        Processing...
                    </div>
                {% endif %}
            </div>

            {% for speaker_group in grouped_segments %}
                <div style="{% if not forloop.last %}border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px;{% endif %}">
                    <div class="flex gap-10 mb-16" style="align-items: baseline;">
                        <div class="status" style="background: #f5f5f5; color: #000;">
                            <i class="fas fa-user" style="font-size: 10px;"></i>
                            {{ speaker_group.speaker }}
                        </div>
                        <div class="text-muted text-small">{{ speaker_group.segments|length }} segment{{ speaker_group.segments|length|pluralize }}</div>
                    </div>

                    {% for segment in speaker_group.segments %}
                        <div style="margin-bottom: 16px; padding-left: 12px; border-left: 2px solid #f0f0f0;">
                            <div class="text-muted text-small" style="margin-bottom: 6px;">
                                <i class="fas fa-clock" style="font-size: 10px; opacity: 0.5;"></i>
                                {{ segment.start_time|floatformat:1 }}s
                                {% if segment.recording_service %}
                                    • {{ segment.recording_service|title }}
                                {% endif %}
                            </div>
                            <div style="line-height: 1.6;">{{ segment.text }}</div>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
    {% endif %}
{% else %}
    <!-- No transcript state -->
    <div class="card" style="text-align: center; padding: 60px 20px;">
        {% if processing_status.total_recordings == 0 %}
            <i class="fas fa-microphone" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="margin-bottom: 12px;">No recordings</h3>
            <p class="text-muted">No audio recordings have been uploaded for this meeting.</p>
        {% else %}
            <i class="fas fa-cog fa-spin" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="margin-bottom: 12px;">Processing audio</h3>
            <p class="text-muted">{{ processing_status.processed_recordings }} of {{ processing_status.total_recordings }} recordings processed</p>
            <div style="margin-top: 20px;">
                <div class="loading" style="margin: 0 auto;"></div>
            </div>
        {% endif %}
    </div>
{% endif %}


<script>
    // Auto-refresh if processing is incomplete
    {% if processing_status.processed_recordings < processing_status.total_recordings or not processing_status.ai_processing_complete %}
        setTimeout(() => {
            window.location.reload();
        }, 15000); // Refresh every 15 seconds
    {% endif %}

    // Toggle transcript visibility
    function toggleTranscript() {
        const transcript = document.getElementById('full-transcript');
        const toggleText = document.getElementById('transcript-toggle-text');
        const isVisible = transcript.style.display !== 'none';

        if (isVisible) {
            transcript.style.display = 'none';
            toggleText.textContent = 'Show Full Transcript';
        } else {
            transcript.style.display = 'block';
            toggleText.textContent = 'Hide Full Transcript';
        }
    }
</script>

{% endblock %}