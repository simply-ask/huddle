{% extends "base.html" %}

{% block title %}Transcript - {{ meeting.title }} | huddle{% endblock %}

{% block content %}

<!-- Simple header with back link -->
<div class="header">
    <div class="flex-between">
        <div>
            <a href="{% url 'meeting_detail' meeting.meeting_id %}" class="text-muted" style="text-decoration: none; margin-bottom: 8px; display: inline-block;">
                <i class="fas fa-arrow-left"></i>
                Back to meeting
            </a>
            <h1 class="logo" style="font-size: 20px; margin-bottom: 4px;">{{ meeting.title|default:"Untitled Meeting" }}</h1>
            <div class="text-muted text-small">Meeting {{ meeting.meeting_id }}</div>
        </div>
        
        <!-- Processing status -->
        <div>
            {% if processing_status.processed_recordings < processing_status.total_recordings %}
                <div class="status status-pending">
                    <i class="fas fa-clock"></i>
                    Processing {{ processing_status.processed_recordings }}/{{ processing_status.total_recordings }}
                </div>
            {% else %}
                <div class="status status-active">
                    <i class="fas fa-check-circle"></i>
                    Complete
                </div>
            {% endif %}
        </div>
    </div>
</div>

{% if all_segments %}
    <!-- Simple stats -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-bottom: 40px;">
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ total_segments }}</div>
            <div class="text-muted text-small">Segments</div>
        </div>
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ grouped_segments|length }}</div>
            <div class="text-muted text-small">Speakers</div>
        </div>
        <div class="card" style="text-align: center; padding: 16px;">
            <div style="font-size: 20px; font-weight: 600;">{{ processing_status.processed_recordings }}</div>
            <div class="text-muted text-small">Recordings</div>
        </div>
    </div>

    <!-- Transcript -->
    <div class="card">
        {% for speaker_group in grouped_segments %}
            <div style="{% if not forloop.last %}border-bottom: 1px solid #f0f0f0; padding-bottom: 20px; margin-bottom: 20px;{% endif %}">
                <div class="flex gap-10 mb-16" style="align-items: baseline;">
                    <div class="status" style="background: #f5f5f5; color: #000;">
                        <i class="fas fa-user" style="font-size: 10px;"></i>
                        {{ speaker_group.speaker }}
                    </div>
                    <div class="text-muted text-small">{{ speaker_group.segments|length }} segment{{ speaker_group.segments|length|pluralize }}</div>
                </div>
                
                {% for segment in speaker_group.segments %}
                    <div style="margin-bottom: 16px; padding-left: 12px; border-left: 2px solid #f0f0f0;">
                        <div class="text-muted text-small" style="margin-bottom: 6px;">
                            <i class="fas fa-clock" style="font-size: 10px; opacity: 0.5;"></i>
                            {{ segment.start_time|floatformat:1 }}s
                            {% if segment.recording_service %}
                                â€¢ {{ segment.recording_service|title }}
                            {% endif %}
                        </div>
                        <div style="line-height: 1.6;">{{ segment.text }}</div>
                    </div>
                {% endfor %}
            </div>
        {% endfor %}
    </div>
{% else %}
    <!-- No transcript state -->
    <div class="card" style="text-align: center; padding: 60px 20px;">
        {% if processing_status.total_recordings == 0 %}
            <i class="fas fa-microphone" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="margin-bottom: 12px;">No recordings</h3>
            <p class="text-muted">No audio recordings have been uploaded for this meeting.</p>
        {% else %}
            <i class="fas fa-cog fa-spin" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
            <h3 style="margin-bottom: 12px;">Processing audio</h3>
            <p class="text-muted">{{ processing_status.processed_recordings }} of {{ processing_status.total_recordings }} recordings processed</p>
            <div style="margin-top: 20px;">
                <div class="loading" style="margin: 0 auto;"></div>
            </div>
        {% endif %}
    </div>
{% endif %}

<!-- AI Summary if available -->
{% if has_summary and summary.summary %}
    <div class="card" style="margin-top: 40px; background: #f8f9fa;">
        <div class="flex gap-10 mb-16">
            <i class="fas fa-brain"></i>
            <h3 style="font-size: 18px; font-weight: 500;">AI Summary</h3>
        </div>
        
        <div style="line-height: 1.6; margin-bottom: 20px;">{{ summary.summary }}</div>
        
        {% if summary.key_points %}
            <div>
                <h4 style="font-size: 14px; font-weight: 500; margin-bottom: 12px;">Key Points</h4>
                <ul style="line-height: 1.6; color: #666;">
                    {% for point in summary.key_points %}
                        <li style="margin-bottom: 8px;">{{ point }}</li>
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
    </div>
{% endif %}

<script>
    // Auto-refresh if processing is incomplete
    {% if processing_status.processed_recordings < processing_status.total_recordings %}
        setTimeout(() => {
            window.location.reload();
        }, 15000); // Refresh every 15 seconds
    {% endif %}
</script>

{% endblock %}